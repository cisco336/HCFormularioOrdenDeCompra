<div class="no-data-grid" *ngIf="isLoading" [@fade]>
  <mat-spinner mode="indeterminate" [diameter]="60"></mat-spinner>
</div>
<div class="the-wrapper" [@entering]="render">
  <mat-card
    class="no-privileges mat-elevation-z4"
    *ngIf="!render && errorMessage"
    [@entering]="errorMessage"
  >
    <h2>{{ errorMessage }}</h2>
  </mat-card>
  <div *ngIf="render">
    <h1 [@child]>
      <span mat-line>Proveedor:</span><span mat-line>{{ proveedor }}</span>
    </h1>
    <button mat-mini-fab color="accent">
      <mat-icon mat-list-icon>help_outline</mat-icon>
    </button>
  </div>
  <mat-card class="mat-elevation-z4 first" *ngIf="render">
    <div [formGroup]="mainFilterForm">
      <mat-form-field class="example-full-width">
        <input
          type="text"
          placeholder="Proveedor"
          aria-label="Proveedor"
          matInput
          required
          formControlName="proveedorControl"
          [matAutocomplete]="proveedor"
        />
        <mat-autocomplete
          #proveedor="matAutocomplete"
          [displayWith]="displayProveedor"
        >
          <mat-option
            *ngFor="let option of filteredProveedores | async"
            [value]="option"
          >
            {{ option.DESCRIPCION }}
          </mat-option>
        </mat-autocomplete>
        <mat-error>Campo requerido.</mat-error>
      </mat-form-field>
      <mat-form-field>
        <input
          type="text"
          placeholder="Estados"
          aria-label="Estados"
          matInput
          required
          formControlName="estadosControl"
          [matAutocomplete]="estados"
        />
        <mat-autocomplete
          #estados="matAutocomplete"
          [displayWith]="displayEstados"
        >
          <mat-option
            *ngFor="let option of filteredEstados | async"
            [value]="option"
          >
            {{ option.DESCRIPCION }}
          </mat-option>
        </mat-autocomplete>
        <mat-error>Campo requerido.</mat-error>
      </mat-form-field>

      <mat-form-field>
        <input
          matInput
          required
          [matDatepicker]="dp1"
          placeholder="Fecha inicio"
          formControlName="fechaInicioControl"
        />
        <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
        <mat-datepicker #dp1></mat-datepicker>
      </mat-form-field>
      <mat-form-field>
        <input
          matInput
          required
          [matDatepicker]="dp2"
          placeholder="Fecha fin"
          formControlName="fechaFinControl"
        />
        <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
        <mat-datepicker #dp2></mat-datepicker>
      </mat-form-field>
    </div>
    <div>
      <button
        mat-raised-button
        color="primary"
        [disabled]="mainFilterForm.invalid"
        (click)="consultar($event, 'GE')"
      >
        <mat-icon mat-list-icon>search</mat-icon> Consultar
      </button>
      <mat-icon
        matTooltip="{{ mainFilterInfo }}"
        [matTooltipPosition]="'right'"
        matTooltipClass="mat-elevation-z8 HC-tooltip-success"
        >info_outline</mat-icon
      >
    </div>
  </mat-card>
  <span [@child]>
    <mat-card class="mat-elevation-z4 second" *ngIf="dataSource">
      <div>
        <h2>
          Opciones:
          <mat-icon
            matTooltip="{{ optionsInfo }}"
            [matTooltipPosition]="'right'"
            matTooltipClass="mat-elevation-z8 HC-tooltip-success"
            >info_outline</mat-icon
          >
        </h2>
        <div>
          <button
            mat-raised-button
            color="accent"
            (click)="openDialogCambioEstado()"
            [disabled]="!selection.selected.length"
          >
            <mat-icon mat-list-icon>category</mat-icon>Cambiar estado
          </button>
          <button
            mat-raised-button
            color="primary"
            #exportButton
            (click)="exportXlsx()"
          >
            <mat-icon mat-list-icon>description</mat-icon>Generar reporte
          </button>
        </div>
      </div>
      <mat-form-field class="filter">
        <input
          matInput
          (keyup)="applyFilter($event.target.value)"
          placeholder="Filtro"
          matTooltip="{{ tableFilterInfo }}"
          [matTooltipPosition]="'above'"
          matTooltipClass="mat-elevation-z8 HC-tooltip-success"
        />
        <mat-icon matSuffix>filter_list</mat-icon>
      </mat-form-field>
      <!-- Tabla de datos Principal -->
      <table
        #table
        mat-table
        [dataSource]="dataSource"
        multiTemplateDataRows
        [@listAnimation]="dataSource.data.length"
      >
        <mat-icon mat-list-icon>info_outline</mat-icon>
        <!-- Checkbox Column -->
        <ng-container matColumnDef="Select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              [aria-label]="checkboxLabel()"
              matTooltip="{{ checkBoxInfo }}"
              [matTooltipPosition]="'above'"
              matTooltipClass="mat-elevation-z8 HC-tooltip-success"
            >
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="$event ? selection.toggle(row) : null"
              [checked]="selection.isSelected(row)"
              [aria-label]="checkboxLabel(row)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Orden -->
        <ng-container matColumnDef="PMG_PO_NUMBER">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="header-orden"
            matTooltip="{{ tableFooterClick }}{{ tableFooterDblclick }}"
            [matTooltipPosition]="'right'"
            matTooltipClass="mat-elevation-z8 HC-tooltip-success"
          >
            # Orden
          </th>
          <td
            mat-cell
            *matCellDef="let element"
            class="position-label"
            (click)="getOrdenDetalle(element)"
            matRipple
            [matRippleColor]="primary"
          >
            {{ element.PMG_PO_NUMBER }}
          </td>
        </ng-container>

        <!-- Estado orden -->
        <ng-container matColumnDef="ESTADO">
          <th mat-header-cell *matHeaderCellDef>Estado orden</th>
          <td mat-cell *matCellDef="let element">
            {{ element.ESTADO }}
          </td>
        </ng-container>

        <!-- Fecha Creación -->
        <ng-container matColumnDef="FECHA_CREACION">
          <th mat-header-cell *matHeaderCellDef>Fecha creación</th>
          <td mat-cell *matCellDef="let element">
            {{ element.FECHA_CREACION }}
          </td>
        </ng-container>

        <!-- Fecha Entrega -->
        <ng-container matColumnDef="PMG_EXP_RCT_DATE">
          <th mat-header-cell *matHeaderCellDef>Fecha entrega</th>
          <td mat-cell *matCellDef="let element">
            {{ element.PMG_EXP_RCT_DATE }}
          </td>
        </ng-container>

        <!-- Detalles -->
        <ng-container matColumnDef="expandedDetail">
          <td
            mat-cell
            *matCellDef="let element"
            [attr.colspan]="displayedColumns.length"
          >
            <div
              class="element-detail "
              [@detailExpand]="
                element == expandedElement ? 'expanded' : 'collapsed'
              "
            >
              <mat-list>
                <mat-list-item>
                  <mat-icon mat-list-icon>today</mat-icon>
                  <span mat-line>Fecha despacho:</span>
                  <span mat-line>
                    {{ element.PMG_SHIP_DATE }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>business</mat-icon>
                  <span mat-line>Almacen a entregar:</span>
                  <span mat-line>
                    {{ element.ORIGEN }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>today</mat-icon>
                  <span mat-line>Fecha real de entrega:</span>
                  <span mat-line>
                    {{ element['Fecha real de entrega'] }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>attach_money</mat-icon>
                  <span mat-line>Valor:</span>
                  <span mat-line>
                    {{ element.PMG_TOT_PO_COST }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>assignment</mat-icon>
                  <span mat-line>Consecutivo nota pedido:</span>
                  <span mat-line>
                    {{ element['Consecutivo nota pedido'] }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>assignment</mat-icon>
                  <span mat-line>Estado nota pedido:</span>
                  <span mat-line>
                    {{ element.PMG_STAT_NAME }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>inbox</mat-icon>
                  <span mat-line>Tipo de entrega:</span>
                  <span mat-line>
                    {{ element['Tipo de entrega'] }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>local_shipping</mat-icon>
                  <span mat-line>Operador (transportadora):</span>
                  <span mat-line>
                    {{ element.VENDOR_NAME }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>call_merge</mat-icon>
                  <span mat-line>Estado de integración:</span>
                  <span mat-line>
                    {{ element['null'] }}
                  </span>
                </mat-list-item>
                <mat-list-item>
                  <mat-icon mat-list-icon>today</mat-icon>
                  <span mat-line>Fecha de integración:</span>
                  <span mat-line>
                    {{ element.PMG_ENTRY_DATE }}
                  </span>
                </mat-list-item>
              </mat-list>
            </div>
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedColumns; sticky: !isLoading"
          [@fade]="dataSource.data.length > 0"
        ></tr>
        <tr
          mat-row
          *matRowDef="let element; columns: displayedColumns"
          class="element-row"
          [class.expanded-row]="expandedElement === element"
          (dblclick)="
            expandedElement = expandedElement === element ? null : element
          "
        ></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: ['expandedDetail']"
          class="detail-row"
        ></tr>
      </table>

      <mat-paginator
        [pageSizeOptions]="[5, 10, 20, 50, 100]"
        showFirstLastButtons
      ></mat-paginator>
    </mat-card>
  </span>
</div>
