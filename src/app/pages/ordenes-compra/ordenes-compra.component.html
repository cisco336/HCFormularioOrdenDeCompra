<div class="no-data-grid" *ngIf="isLoading" [@fade]>
  <mat-spinner mode="indeterminate" [diameter]="60"></mat-spinner>
</div>
<div class="the-wrapper" [@entering]>
  <mat-card class="no-privileges mat-elevation-z4" *ngIf="!render && noData" [@entering]>
    <h2>{{ errorMessage }}</h2>
  </mat-card>
  <div *ngIf="render" [@entering]>
    <h1 >
      <span>Proveedor:</span><span >{{ proveedor }}</span>
    </h1>
    <button mat-mini-fab color="accent">
      <mat-icon>help_outline</mat-icon>
    </button>
  </div>
  <mat-card class="mat-elevation-z4 first" *ngIf="render" >
    <div [formGroup]="mainFilterForm">
      <mat-form-field class="example-full-width">
        <input
          type="text"
          placeholder="Proveedor"
          aria-label="Proveedor"
          matInput
          required
          formControlName="proveedorControl"
          [matAutocomplete]="proveedor"
        />
        <mat-autocomplete
          #proveedor="matAutocomplete"
          [displayWith]="displayProveedor"
        >
          <mat-option
            *ngFor="let option of filteredProveedores | async"
            [value]="option"
          >
            {{ option.DESCRIPCION }}
          </mat-option>
        </mat-autocomplete>
        <mat-error>Campo requerido.</mat-error>
      </mat-form-field>
      <mat-form-field>
        <input
          type="text"
          placeholder="Estados"
          aria-label="Estados"
          matInput
          required
          formControlName="estadosControl"
          [matAutocomplete]="estados"
        />
        <mat-autocomplete
          #estados="matAutocomplete"
          [displayWith]="displayEstados"
        >
          <mat-option
            *ngFor="let option of filteredEstados | async"
            [value]="option"
          >
            {{ option.DESCRIPCION }}
          </mat-option>
        </mat-autocomplete>
        <mat-error>Campo requerido.</mat-error>
      </mat-form-field>

      <mat-form-field>
        <input
          matInput
          required
          [matDatepicker]="dp1"
          placeholder="Fecha inicio"
          formControlName="fechaInicioControl"
        />
        <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
        <mat-datepicker #dp1></mat-datepicker>
      </mat-form-field>
      <mat-form-field>
        <input
          matInput
          required
          [matDatepicker]="dp2"
          placeholder="Fecha fin"
          formControlName="fechaFinControl"
        />
        <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
        <mat-datepicker #dp2></mat-datepicker>
      </mat-form-field>
    </div>
    <div>
      <button
        mat-raised-button
        color="primary"
        [disabled]="mainFilterForm.invalid"
        (click)="consultar($event, 'GE')"
      >
        <mat-icon>search</mat-icon> Consultar
      </button>
      <mat-icon
        matTooltip="{{ mainFilterInfo }}"
        [matTooltipPosition]="'right'"
        matTooltipClass="mat-elevation-z8 HC-tooltip-success"
        >info_outline</mat-icon
      >
    </div>
  </mat-card>
  <mat-card class="mat-elevation-z4 second" *ngIf="render">
    <div>
      <h2>
        Opciones:
        <mat-icon
          matTooltip="{{ optionsInfo }}"
          [matTooltipPosition]="'right'"
          matTooltipClass="mat-elevation-z8 HC-tooltip-success"
          >info_outline</mat-icon
        >
      </h2>
      <div>
        <button
          mat-raised-button
          color="accent"
          (click)="openDialogCambioEstado($event)"
          [disabled]="!selection.selected.length"
        >
          <mat-icon>category</mat-icon>Cambiar estado
        </button>
        <button
          mat-raised-button
          color="primary"
          #exportButton
          (click)="exportXlsx()"
        >
          <mat-icon>description</mat-icon>Generar reporte
        </button>
      </div>
    </div>
    <mat-form-field class="filter">
      <input
        matInput
        (keyup)="applyFilter($event.target.value)"
        placeholder="Filtro"
        matTooltip="{{ tableFilterInfo }}"
        [matTooltipPosition]="'above'"
        matTooltipClass="mat-elevation-z8 HC-tooltip-success"
      />
      <mat-icon matSuffix>filter_list</mat-icon>
    </mat-form-field>
    <!-- Tabla de datos Principal -->
    <table
      #table
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      [@listAnimation]="dataSource.data.length"
    >
      <mat-icon>info_outline</mat-icon>
      <!-- Checkbox Column -->
      <ng-container matColumnDef="Select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            [aria-label]="checkboxLabel()"
            matTooltip="{{ checkBoxInfo }}"
            [matTooltipPosition]="'above'"
            matTooltipClass="mat-elevation-z8 HC-tooltip-success"
          >
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"
            [aria-label]="checkboxLabel(row)"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Orden -->
      <ng-container matColumnDef="Orden">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="header-orden"
          matTooltip="{{ tableFooterClick }}{{ tableFooterDblclick }}"
          [matTooltipPosition]="'right'"
          matTooltipClass="mat-elevation-z8 HC-tooltip-success"
        >
          # Orden
        </th>
        <td
          mat-cell
          *matCellDef="let element"
          class="position-label"
          (click)="openDialogDetalles(element)"
          matRipple
          [matRippleColor]="primary"
        >
          {{ element.Orden }}
        </td>
      </ng-container>

      <!-- Estado orden -->
      <ng-container matColumnDef="Estado orden">
        <th mat-header-cell *matHeaderCellDef>Estado orden</th>
        <td mat-cell *matCellDef="let element">
          {{ element["Estado orden"] }}
        </td>
      </ng-container>

      <!-- Fecha Creación -->
      <ng-container matColumnDef="Fecha creación">
        <th mat-header-cell *matHeaderCellDef>Fecha creación</th>
        <td mat-cell *matCellDef="let element">
          {{ element["Fecha creación"] }}
        </td>
      </ng-container>

      <!-- Fecha Entrega -->
      <ng-container matColumnDef="Fecha entrega">
        <th mat-header-cell *matHeaderCellDef>Fecha entrega</th>
        <td mat-cell *matCellDef="let element">
          {{ element["Fecha entrega"] }}
        </td>
      </ng-container>

      <!-- Detalles -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="displayedColumns.length"
        >
          <div
            class="element-detail "
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          >
            <div>
              <mat-icon>today</mat-icon>
              <span>Fecha despacho:</span>
              <span>
                {{ element["Fecha despacho"] }}
              </span>
            </div>
            <div>
              <mat-icon>business</mat-icon>
              <span>Almacen a entregar:</span>
              <span>
                {{ element["Almacen a entregar"] }}
              </span>
            </div>
            <div>
              <mat-icon>today</mat-icon>
              <span>Fecha real de entrega:</span>
              <span>
                {{ element["Fecha real de entrega"] }}
              </span>
            </div>
            <div>
              <mat-icon>attach_money</mat-icon>
              <span>Valor:</span>
              <span>
                {{ element["Valor"] }}
              </span>
            </div>
            <div>
              <mat-icon>assignment</mat-icon>
              <span>Consecutivo nota pedido:</span>
              <span>
                {{ element["Consecutivo nota pedido"] }}
              </span>
            </div>
            <div>
              <mat-icon>assignment</mat-icon>
              <span>Estado nota pedido:</span>
              <span>
                {{ element["Estado nota pedido"] }}
              </span>
            </div>
            <div>
              <mat-icon>inbox</mat-icon>
              <span>Tipo de entrega:</span>
              <span>
                {{ element["Tipo de entrega"] }}
              </span>
            </div>
            <div>
              <mat-icon>local_shipping</mat-icon>
              <span>Operador (transportadora):</span>
              <span>
                {{ element["Operador (transportadora)"] }}
              </span>
            </div>
            <div>
              <mat-icon>call_merge</mat-icon>
              <span>Estado de integración:</span>
              <span>
                {{ element["Estado de integración"] }}
              </span>
            </div>
            <div>
              <mat-icon>today</mat-icon>
              <span>Fecha de integración:</span>
              <span>
                {{ element["Fecha de integración"] }}
              </span>
            </div>
          </div>
        </td>
      </ng-container>

      <tr
        mat-header-row
        *matHeaderRowDef="displayedColumns; sticky: !isLoading"
        [@fade]="dataSource.data.length > 0"
      ></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: displayedColumns"
        class="element-row"
        [class.expanded-row]="expandedElement === element"
        (dblclick)="
          expandedElement = expandedElement === element ? null : element
        "
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="detail-row"
      ></tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[5, 10, 20, 50, 100]"
      showFirstLastButtons
    ></mat-paginator>
  </mat-card>
</div>
